{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Th·ªëng k√™ Nh√† h√†ng{% endblock %}

{% block extrastyle %}
<style>
    .statistics-container {
        padding: 20px;
        background: #f8f9fa;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.2s;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .stat-card.revenue {
        border-left: 4px solid #28a745;
    }
    
    .stat-card.orders {
        border-left: 4px solid #007bff;
    }
    
    .stat-card.dishes {
        border-left: 4px solid #ffc107;
    }
    
    .stat-card.tables {
        border-left: 4px solid #17a2b8;
    }
    
    .stat-card.staff {
        border-left: 4px solid #6f42c1;
    }
    
    .stat-card.customers {
        border-left: 4px solid #fd7e14;
    }
    
    .stat-card.ingredients {
        border-left: 4px solid #dc3545;
    }
    
    .stat-card.chat {
        border-left: 4px solid #20c997;
    }
    
    .stat-label {
        font-size: 14px;
        color: #6c757d;
        margin-bottom: 8px;
        font-weight: 500;
    }
    
    .stat-value {
        font-size: 32px;
        font-weight: bold;
        color: #333;
        margin-bottom: 5px;
    }
    
    .stat-subtitle {
        font-size: 12px;
        color: #6c757d;
    }
    
    .section-title {
        font-size: 24px;
        font-weight: bold;
        margin: 30px 0 15px 0;
        padding-bottom: 10px;
        border-bottom: 2px solid #dee2e6;
        color: #333;
    }
    
    .table-container {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        overflow-x: auto;
    }
    
    .stats-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .stats-table th {
        background: #f8f9fa;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid #dee2e6;
    }
    
    .stats-table td {
        padding: 12px;
        border-bottom: 1px solid #dee2e6;
    }
    
    .stats-table tr:hover {
        background: #f8f9fa;
    }
    
    .badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }
    
    .badge-success { background: #d4edda; color: #155724; }
    .badge-warning { background: #fff3cd; color: #856404; }
    .badge-danger { background: #f8d7da; color: #721c24; }
    .badge-info { background: #d1ecf1; color: #0c5460; }
    .badge-primary { background: #cce5ff; color: #004085; }
    
    .chart-container {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .progress {
        height: 20px;
        background: #e9ecef;
        border-radius: 10px;
        overflow: hidden;
        margin: 10px 0;
    }
    
    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #007bff, #0056b3);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 12px;
        font-weight: 600;
        transition: width 0.3s;
    }
    
    .alert {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .alert-warning {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        color: #856404;
    }
    
    .alert-danger {
        background: #f8d7da;
        border-left: 4px solid #dc3545;
        color: #721c24;
    }
    
    .two-column-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }
    
    @media (max-width: 768px) {
        .two-column-grid {
            grid-template-columns: 1fr;
        }
    }
    
    .summary-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #e9ecef;
    }
    
    .summary-item:last-child {
        border-bottom: none;
    }
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set width cho progress bars t·ª´ data attribute
    document.querySelectorAll('.progress-bar[data-width]').forEach(function(el) {
        var width = el.getAttribute('data-width');
        el.style.width = width + '%';
    });
});
</script>
{% endblock %}

{% block content %}
<div class="statistics-container">
    <h1 style="margin-bottom: 30px; color: #333;">üìä Th·ªëng k√™ T·ªïng quan Nh√† h√†ng</h1>
    
    <!-- T·ªïng quan ch√≠nh -->
    <div class="stats-grid">
        <div class="stat-card revenue">
            <div class="stat-label">üí∞ T·ªïng Doanh Thu</div>
            <div class="stat-value">{{ total_revenue|floatformat:0 }} ‚Ç´</div>
            <div class="stat-subtitle">T·∫•t c·∫£ th·ªùi gian</div>
        </div>
        
        <div class="stat-card revenue">
            <div class="stat-label">üíµ Doanh Thu H√¥m Nay</div>
            <div class="stat-value">{{ revenue_today|floatformat:0 }} ‚Ç´</div>
            <div class="stat-subtitle">{{ revenue_today|floatformat:0 }}</div>
        </div>
        
        <div class="stat-card revenue">
            <div class="stat-label">üìÖ Doanh Thu 30 Ng√†y</div>
            <div class="stat-value">{{ revenue_30days|floatformat:0 }} ‚Ç´</div>
            <div class="stat-subtitle">Th√°ng g·∫ßn nh·∫•t</div>
        </div>
        
        <div class="stat-card orders">
            <div class="stat-label">üõí T·ªïng ƒê∆°n H√†ng</div>
            <div class="stat-value">{{ total_orders }}</div>
            <div class="stat-subtitle">H√¥m nay: {{ orders_today }} | 30 ng√†y: {{ orders_30days }}</div>
        </div>
        
        <div class="stat-card dishes">
            <div class="stat-label">üçΩÔ∏è M√≥n ƒÇn</div>
            <div class="stat-value">{{ total_dishes }}</div>
            <div class="stat-subtitle">C√≥ s·∫µn: {{ available_dishes }} | H·∫øt: {{ unavailable_dishes }}</div>
        </div>
        
        <div class="stat-card tables">
            <div class="stat-label">ü™ë B√†n ƒÇn</div>
            <div class="stat-value">{{ total_tables }}</div>
            <div class="stat-subtitle">ƒêang d√πng: {{ active_tables }} | S·ª©c ch·ª©a: {{ total_capacity }} ng∆∞·ªùi</div>
        </div>
        
        <div class="stat-card staff">
            <div class="stat-label">üë®‚Äçüç≥ Nh√¢n Vi√™n</div>
            <div class="stat-value">{{ total_staff }}</div>
            <div class="stat-subtitle">ƒêang l√†m: {{ staff_working }}</div>
        </div>
        
        <div class="stat-card customers">
            <div class="stat-label">üë• Kh√°ch H√†ng</div>
            <div class="stat-value">{{ total_customers }}</div>
            <div class="stat-subtitle">V√£ng lai: {{ total_khach_vang_lai }} | C√≥ ƒë∆°n: {{ customers_with_orders }}</div>
        </div>
        
        <div class="stat-card ingredients">
            <div class="stat-label">üì¶ Nguy√™n Li·ªáu</div>
            <div class="stat-value">{{ total_ingredients }}</div>
            <div class="stat-subtitle">C·∫£nh b√°o: <span style="color: #dc3545; font-weight: bold;">{{ low_stock }}</span></div>
        </div>
        
        <div class="stat-card chat">
            <div class="stat-label">üí¨ Tin Nh·∫Øn</div>
            <div class="stat-value">{{ total_messages }}</div>
            <div class="stat-subtitle">H√¥m nay: {{ messages_today }} | 7 ng√†y: {{ messages_7days }}</div>
        </div>
        
        <div class="stat-card revenue">
            <div class="stat-label">üöö Ph√≠ Giao H√†ng</div>
            <div class="stat-value">{{ total_shipping_fee|floatformat:0 }} ‚Ç´</div>
            <div class="stat-subtitle">T·ªïng thu ƒë∆∞·ª£c</div>
        </div>
        
        <div class="stat-card orders">
            <div class="stat-label">‚è±Ô∏è Th·ªùi Gian Chu·∫©n B·ªã TB</div>
            <div class="stat-value">{% if avg_prep_time %}{{ avg_prep_time|floatformat:0 }}{% else %}N/A{% endif %}</div>
            <div class="stat-subtitle">Ph√∫t</div>
        </div>
    </div>
    
    <!-- C·∫£nh b√°o Nguy√™n li·ªáu -->
    {% if low_stock > 0 %}
    <div class="alert alert-danger">
        <strong>‚ö†Ô∏è C·∫£nh b√°o!</strong> C√≥ {{ low_stock }} nguy√™n li·ªáu ƒëang d∆∞·ªõi ng∆∞·ª°ng t·ªìn kho c·∫ßn nh·∫≠p h√†ng ngay!
    </div>
    {% endif %}
    
    <!-- ƒê∆°n h√†ng theo tr·∫°ng th√°i -->
    <h2 class="section-title">üìä ƒê∆°n H√†ng Theo Tr·∫°ng Th√°i</h2>
    <div class="table-container">
        <table class="stats-table">
            <thead>
                <tr>
                    <th>Tr·∫°ng th√°i</th>
                    <th>S·ªë l∆∞·ª£ng</th>
                    <th>T·ª∑ l·ªá</th>
                </tr>
            </thead>
            <tbody>
                {% for item in orders_by_status %}
                <tr>
                    <td>
                        {% if item.trang_thai == 'pending' %}
                            <span class="badge badge-warning">Ch·ªù x√°c nh·∫≠n</span>
                        {% elif item.trang_thai == 'confirmed' %}
                            <span class="badge badge-info">ƒê√£ x√°c nh·∫≠n</span>
                        {% elif item.trang_thai == 'cooking' %}
                            <span class="badge badge-primary">ƒêang n·∫•u</span>
                        {% elif item.trang_thai == 'ready' %}
                            <span class="badge badge-success">S·∫µn s√†ng</span>
                        {% elif item.trang_thai == 'completed' %}
                            <span class="badge badge-success">Ho√†n th√†nh</span>
                        {% else %}
                            <span class="badge badge-danger">ƒê√£ h·ªßy</span>
                        {% endif %}
                    </td>
                    <td><strong>{{ item.count }}</strong></td>
                    <td>
                        {% widthratio item.count total_orders 100 %}%
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Top m√≥n b√°n ch·∫°y -->
    <h2 class="section-title">üèÜ Top M√≥n B√°n Ch·∫°y Nh·∫•t</h2>
    <div class="table-container">
        <table class="stats-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>T√™n m√≥n</th>
                    <th>S·ªë l∆∞·ª£ng ƒë√£ b√°n</th>
                    <th>Doanh thu</th>
                </tr>
            </thead>
            <tbody>
                {% for item in top_dishes %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td><strong>{{ item.mon_an__ten_mon }}</strong></td>
                    <td>{{ item.total_sold }}</td>
                    <td>{{ item.revenue|floatformat:0 }} ‚Ç´</td>
                </tr>
                {% empty %}
                <tr><td colspan="4" style="text-align: center;">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Top m√≥n b√°n ch·∫°y 7 ng√†y -->
    <h2 class="section-title">üî• Top M√≥n B√°n Ch·∫°y 7 Ng√†y Qua</h2>
    <div class="table-container">
        <table class="stats-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>T√™n m√≥n</th>
                    <th>S·ªë l∆∞·ª£ng</th>
                    <th>Xu h∆∞·ªõng</th>
                </tr>
            </thead>
            <tbody>
                {% for item in top_dishes_7days %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td><strong>{{ item.mon_an__ten_mon }}</strong></td>
                    <td>{{ item.total_sold }}</td>
                    <td>
                        <div class="progress">
                            <div class="progress-bar" data-width="{{ item.percentage }}">
                                {{ item.total_sold }}
                            </div>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="4" style="text-align: center;">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Top nh√¢n vi√™n -->
    <h2 class="section-title">‚≠ê Top Nh√¢n Vi√™n Xu·∫•t S·∫Øc</h2>
    <div class="table-container">
        <table class="stats-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>H·ªç t√™n</th>
                    <th>S·ªë ƒë∆°n ƒë√£ x·ª≠ l√Ω</th>
                </tr>
            </thead>
            <tbody>
                {% for item in top_staff %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td><strong>{{ item.nhan_vien__ho_ten }}</strong></td>
                    <td>{{ item.order_count }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="3" style="text-align: center;">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Top kh√°ch h√†ng -->
    <h2 class="section-title">üëë Top Kh√°ch H√†ng Th√¢n Thi·∫øt</h2>
    <div class="table-container">
        <table class="stats-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>H·ªç t√™n</th>
                    <th>S·ªë ƒëi·ªán tho·∫°i</th>
                    <th>S·ªë ƒë∆°n h√†ng</th>
                </tr>
            </thead>
            <tbody>
                {% for item in top_customers %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td><strong>{{ item.khach_hang__ho_ten }}</strong></td>
                    <td>{{ item.khach_hang__so_dien_thoai }}</td>
                    <td>{{ item.order_count }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="4" style="text-align: center;">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Nguy√™n li·ªáu c·∫ßn nh·∫≠p -->
    {% if ingredients_need_restock %}
    <h2 class="section-title">‚ö†Ô∏è Nguy√™n Li·ªáu C·∫ßn Nh·∫≠p Kh·∫©n</h2>
    <div class="table-container">
        <table class="stats-table">
            <thead>
                <tr>
                    <th>T√™n nguy√™n li·ªáu</th>
                    <th>S·ªë l∆∞·ª£ng hi·ªán t·∫°i</th>
                    <th>Ng∆∞·ª°ng c·∫£nh b√°o</th>
                    <th>ƒê∆°n v·ªã</th>
                    <th>Tr·∫°ng th√°i</th>
                </tr>
            </thead>
            <tbody>
                {% for item in ingredients_need_restock %}
                <tr>
                    <td><strong>{{ item.ten_nguyen_lieu }}</strong></td>
                    <td style="color: #dc3545; font-weight: bold;">{{ item.so_luong }}</td>
                    <td>{{ item.threshold }}</td>
                    <td>{{ item.don_vi }}</td>
                    <td><span class="badge badge-danger">C·∫ßn nh·∫≠p g·∫•p</span></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
    
    <!-- Th·ªëng k√™ b·ªï sung -->
    <div class="two-column-grid">
        <!-- B√†n theo khu v·ª±c -->
        <div class="table-container">
            <h3 style="margin-bottom: 15px;">üè† B√†n Theo Khu V·ª±c</h3>
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>Khu v·ª±c</th>
                        <th>S·ªë b√†n</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in tables_by_area %}
                    <tr>
                        <td>
                            {% if item.khu_vuc == 'inside' %}Trong nh√†
                            {% elif item.khu_vuc == 'outside' %}Ngo√†i tr·ªùi
                            {% else %}VIP
                            {% endif %}
                        </td>
                        <td><strong>{{ item.count }}</strong></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Nh√¢n vi√™n theo ch·ª©c v·ª• -->
        <div class="table-container">
            <h3 style="margin-bottom: 15px;">üëî Nh√¢n Vi√™n Theo Ch·ª©c V·ª•</h3>
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>Ch·ª©c v·ª•</th>
                        <th>S·ªë l∆∞·ª£ng</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in staff_by_role %}
                    <tr>
                        <td>{{ item.get_chuc_vu_display|default:item.chuc_vu }}</td>
                        <td><strong>{{ item.count }}</strong></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="two-column-grid">
        <!-- ƒê∆°n theo lo·∫°i -->
        <div class="table-container">
            <h3 style="margin-bottom: 15px;">üì¶ ƒê∆°n H√†ng Theo Lo·∫°i</h3>
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>Lo·∫°i</th>
                        <th>S·ªë l∆∞·ª£ng</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in orders_by_type %}
                    <tr>
                        <td>
                            {% if item.loai_order == 'dine_in' %}
                                <span class="badge badge-info">ƒÇn t·∫°i ch·ªó</span>
                            {% else %}
                                <span class="badge badge-warning">Mang v·ªÅ</span>
                            {% endif %}
                        </td>
                        <td><strong>{{ item.count }}</strong></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Danh m·ª•c m√≥n ƒÉn -->
        <div class="table-container">
            <h3 style="margin-bottom: 15px;">üìã Danh M·ª•c M√≥n ƒÇn</h3>
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>Danh m·ª•c</th>
                        <th>S·ªë m√≥n</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in categories_stats %}
                    <tr>
                        <td><strong>{{ item.ten_danh_muc }}</strong></td>
                        <td>{{ item.dish_count }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Footer -->
    <div style="text-align: center; margin-top: 40px; padding: 20px; color: #6c757d;">
        <p>üìä Th·ªëng k√™ ƒë∆∞·ª£c c·∫≠p nh·∫≠t t·ª± ƒë·ªông | üïê C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: {{ request.timestamp|default:"V·ª´a xong" }}</p>
        <p><a href="{% url 'admin:index' %}" style="color: #007bff;">‚Üê Quay l·∫°i trang qu·∫£n tr·ªã</a></p>
    </div>
</div>
{% endblock %}
